name: Release CLI

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  GO_VERSION: '1.23'
  BINARY_NAME: tiny-cli
  SERVER_HOST: api.tiny.link
  URL_SERVICE_PORT: "50051"
  USER_SERVICE_PORT: "50052"

jobs:
  build:
    name: Build ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
            ext: ''
          - os: linux
            arch: arm64
            ext: ''
          - os: darwin
            arch: amd64
            ext: ''
          - os: darwin
            arch: arm64
            ext: ''
          - os: windows
            arch: amd64
            ext: '.exe'
          - os: windows
            arch: arm64
            ext: '.exe'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build binary
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          CGO_ENABLED: 0
        run: |
          OUTPUT_NAME="${{ env.BINARY_NAME }}-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.ext }}"
          go build \
            -ldflags="-s -w \
              -X main.version=${{ steps.version.outputs.VERSION }} \
              -X main.commit=${{ github.sha }} \
              -X main.date=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
              -X github.com/Varun5711/shorternit/cmd/tui/config.URLServiceAddr=${{ env.SERVER_HOST }}:${{ env.URL_SERVICE_PORT }} \
              -X github.com/Varun5711/shorternit/cmd/tui/config.UserServiceAddr=${{ env.SERVER_HOST }}:${{ env.USER_SERVICE_PORT }}" \
            -trimpath \
            -o "dist/${OUTPUT_NAME}" \
            ./cmd/tui

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BINARY_NAME }}-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/
          merge-multiple: true

      - name: Generate checksums
        run: |
          cd dist
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ env.BINARY_NAME }} ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            dist/*
          body: |
            ## Installation

            ### macOS (Homebrew)
            ```bash
            brew install Varun5711/tap/tiny-cli
            ```

            ### macOS / Linux (Direct Download)
            ```bash
            curl -sSL https://raw.githubusercontent.com/Varun5711/shorternit/main/scripts/install.sh | bash
            ```

            ### Windows (Scoop)
            ```powershell
            scoop bucket add tiny https://github.com/Varun5711/scoop-tiny
            scoop install tiny-cli
            ```

            ### Manual Download
            Download the appropriate binary for your platform below.

            ### Usage
            ```bash
            # Just run it! Server address is built-in.
            tiny-cli

            # Check version and server info
            tiny-cli --version
            ```

            ## Checksums
            Verify your download with SHA256:
            ```
            $(cat dist/checksums.txt)
            ```
